---
title: "opioid"
author: "Jiayi Liu"
output: html_document
---
install data
```{r}
opioid = read.table("LRdata.csv", sep=',', header = TRUE)
#install.packages('car')
#install.packages('psych')
#install.packages('MASS')
library(MASS)
library(car)
library(psych)
str(opioid)
```

#look at correlations, scatterplots
```{r}
pairs(~Death.Rate+Unemployment+Poverty+Median.Income+Home.Price+no.high.school,data=opioid, main="Simple Scatterplot Matrix")

scatterplotMatrix(~Death.Rate+Unemployment+Poverty+Median.Income+Home.Price+no.high.school,data=opioid, smooth = FALSE, ellipse="FALSE", main="Simple Scatterplot Matrix")
cor(opioid[,2:7])
corr.test(opioid[,2:7], y = NULL, use ="pairwise",method="pearson",adjust="holm",alpha=.05)

par(mfrow=c(3,2))
hist(opioid$Unemployment)
hist(opioid$Poverty)
hist(opioid$Median.Income)
hist(opioid$Home.Price)
hist(opioid$no.high.school)
```
#more on correlation plots with p-values


```{r}
library(corrplot)
M <- cor(opioid[,2:7])
corrplot(M,method="number")
corrplot(M,method="pie")
corrplot.mixed(M)

# matrix of the p-value of the correlation
p.mat <- cor.mtest(opioid[,2:7], conf.level=0.95)
corrplot(M, p.mat = p.mat$p, sig.level=0.05, insig="p-value")
```

# build regression models

```{r}
null=lm(Death.Rate~1, data=opioid)
summary(null)
full = lm(Death.Rate~.-County, data=opioid)
summary(full)
step(null, scope=list(lower=null, upper=full),direction="forward")
```

#basic additive model
```{r}
#rline<-lm(formula = opioid$Death.Rate ~ opioid$Unemployment+opioid$Poverty+opioid$Median.Income+opioid$Home.Price+opioid$no.high.school)
#summary(rline)
rline0<-lm(formula=opioid$Death.Rate ~ opioid$Median.Income+opioid$Home.Price+opioid$no.high.school)
summary(rline0)
rline2<-lm(formula = opioid$Death.Rate ~ opioid$Median.Income+opioid$Home.Price)
summary(rline2)
rline3<-lm(formula = opioid$Death.Rate ~ opioid$Median.Income+opioid$Home.Price+opioid$Home.Price*opioid$Median.Income)
summary(rline3)
```

#diagnostics on residuals
```{r}
plot(rline2,which=1:4)
shapiro.test(rline2$residuals)
ncvTest(rline2)
e=residuals(rline2)
plot(opioid$Unemployment, e, xlab = "unemployment", ylab =
             "resid")
abline(0,0, col="red")
plot(opioid$Poverty, e, xlab = "poverty", ylab =
             "resid")
abline(0,0, col="red")
plot(opioid$Median.Income, e, xlab = "median income", ylab =
             "resid")
abline(0,0, col="red")
plot(opioid$Home.Price, e, xlab = "home price", ylab =
             "resid")
abline(0,0, col="red")
```

#Attempts at transformations to get constance of variance box cox
#Have to artificially inflate rate=0 to be able to do boxcox
```{r}
opioid_boxcox<-opioid
opioid_boxcox[,2][opioid_boxcox[,2] == 0] <- 0.0001
opioid_boxcox
rline_boxcox<-lm(formula = opioid_boxcox$Death.Rate~opioid_boxcox$Median.Income+opioid_boxcox$Home.Price)
boxcox(rline_boxcox)
```
#Now we pass the Breusch-Pagan test for constant variance, visual inspection still does not look great, and we lost normality.

```{r}
rline_transform<-lm(formula = sqrt(opioid$Death.Rate) ~ opioid$Median.Income+opioid$Home.Price)
plot(rline_transform, which=1:4)
shapiro.test(rline_transform$residuals)
ncvTest(rline_transform)
e2=residuals(rline_transform)

plot(opioid$Median.Income, e2, xlab = "median income", ylab =
             "resid")
abline(0,0, col="red")
plot(opioid$Home.Price, e2, xlab = "home price", ylab =
             "resid")
abline(0,0, col="red")
```

#Trying to remove outliers instead to see if this gives a better result for constant variance/linearity
#First taking a look at marginal plots to see where model diverges from data (looking at transformed and non-transformed version)
```{r}
par(mfrow=c(2,2))
mmp(rline2,opioid$Home.Price)
mmp(rline2,opioid$Median.Income)
mmp(rline_transform,opioid$Home.Price)
mmp(rline_transform,opioid$Median.Income)
```

#Now looking at Cook's Measure, influence plots. For original regression line, problem points are 12,14,18. For transformed line, problem is 14,18,25
```{r}
influencePlot(rline2)
outlierTest(rline2)
influenceIndexPlot(rline2)
plot(rline2,which=3:4)

influencePlot(rline_transform)
outlierTest(rline_transform)
influenceIndexPlot(rline_transform)
plot(rline_transform,which=3:4)
```
influencePlot(rline2)
outlierTest(rline2)
influenceIndexPlot(rline2)
plot(rline2,which=3:4)

influencePlot(rline_transform)
outlierTest(rline_transform)
influenceIndexPlot(rline_transform)
plot(rline_transform,which=3:4)



#Here are diagnostics repeated for the regular regression line after outliers have been removed. Visual inspection does not look good but we pass formal tests.
```{r}
opioid_outliers<-opioid[-c(12,14,18),]
rline_outliers<-lm(formula = Death.Rate ~ Median.Income+Home.Price, data=opioid_outliers)
plot(rline_outliers,which = 1:4)
mmp(rline_outliers,opioid_outliers$Home.Price)
mmp(rline_outliers,opioid_outliers$Median.Income)

shapiro.test(rline_outliers$residuals)
ncvTest(rline_outliers)
e3=residuals(rline_outliers)
plot(opioid_outliers$Median.Income, e3, xlab = "median income", ylab =
             "resid")
abline(0,0, col="red")
plot(opioid_outliers$Home.Price, e3, xlab = "home price", ylab =
             "resid")
abline(0,0, col="red")

```

#Here are diagnostics repeated for regression line with transformation, after outliers have been removed. Does not seem to have improved anything.
```{r}
opioid_outliers_transform<-opioid[-c(22,25),]
rline_outliers_transform<-lm(formula = sqrt(opioid_outliers_transform$Death.Rate) ~ opioid_outliers_transform$Median.Income+opioid_outliers_transform$Home.Price)
summary(rline_outliers_transform)
mmp(rline_outliers_transform,opioid_outliers_transform$Home.Price)
mmp(rline_outliers_transform,opioid_outliers_transform$Median.Income)
plot(rline_outliers_transform, which=1:4)

shapiro.test(rline_outliers_transform$residuals)
ncvTest(rline_outliers_transform)
e4=residuals(rline_outliers_transform)
plot(opioid_outliers_transform$Median.Income, e4, xlab = "median income", ylab =
             "resid")
abline(0,0, col="red")
plot(opioid_outliers_transform$Home.Price, e4, xlab = "home price", ylab =
             "resid")
abline(0,0, col="red")
```

#Let's compare some models to see R^2 values.

```{r}
rline<-lm(formula = opioid$Death.Rate ~ opioid$Unemployment+opioid$Poverty+opioid$Median.Income+opioid$Home.Price+opioid$no.high.school)
summary(rline)
rline2<-lm(formula = opioid$Death.Rate ~ opioid$Median.Income+opioid$Home.Price)
summary(rline2)
rline_transform_full<-lm(formula = sqrt(opioid$Death.Rate) ~ opioid$Unemployment+opioid$Poverty+opioid$Median.Income+opioid$Home.Price+opioid$no.high.school)
summary(rline_transform_full)
rline_transform<-lm(formula = sqrt(opioid$Death.Rate) ~ opioid$Median.Income+opioid$Home.Price)
summary(rline_transform)

rline_outliers_transform_full<-lm(formula = sqrt(opioid_outliers_transform$Death.Rate) ~ opioid_outliers_transform$Unemployment+opioid_outliers_transform$Poverty+opioid_outliers_transform$Median.Income+opioid_outliers_transform$Home.Price+opioid_outliers_transform$no.high.school)
summary(rline_outliers_transform_full)
rline_outliers_transform<-lm(formula = sqrt(opioid_outliers_transform$Death.Rate) ~ opioid_outliers_transform$Median.Income+opioid_outliers_transform$Home.Price)
summary(rline_outliers_transform)

rline_outliers_full<-lm(formula = opioid_outliers$Death.Rate ~ opioid_outliers$Unemployment+opioid_outliers$Poverty+opioid_outliers$Median.Income+opioid_outliers$Home.Price+opioid_outliers$no.high.school)
summary(rline_outliers_full)
rline_outliers<-lm(formula = opioid_outliers$Death.Rate ~ opioid_outliers$Median.Income+opioid_outliers$Home.Price)
summary(rline_outliers)
```


#Checking interaction term. For both top models, interaction is not significant.
```{r}
rinteraction_transform<-lm(formula = sqrt(opioid$Death.Rate) ~ opioid$Median.Income+opioid$Home.Price+opioid$Median.Income*opioid$Home.Price)
anova(rline_transform, rinteraction_transform)

rinteraction_outliers<-lm(formula = opioid_outliers$Death.Rate ~ opioid_outliers$Median.Income+opioid_outliers$Home.Price+opioid_outliers$Median.Income*opioid_outliers$Home.Price)
anova(rline_outliers, rinteraction_outliers)
```


#Step function AIC, also suggests using both predictors for additive model.
```{r}
library(MASS)
#fit1 <- lm(y ~ ., data)
#fit2 <- lm(y ~ 1, data)
additive_null=lm(Death.Rate~1, data=opioid_outliers)
stepAIC(rline_outliers,direction="backward")
stepAIC(additive_null,direction="forward",scope=list(upper=rline_outliers,lower=additive_null))
stepAIC(additive_null,direction="both",scope=list(upper=rline_outliers,lower=additive_null))

additive_null=lm(sqrt(Death.Rate)~1, data=opioid)
stepAIC(rline_transform,direction="backward")
stepAIC(additive_null,direction="forward",scope=list(upper=rline_transform,lower=additive_null))
stepAIC(additive_null,direction="both",scope=list(upper=rline_transform,lower=additive_null))
```

#Plots of the final model:
```{r eval=FALSE }
library(plotly)
library(reshape2)
#Setup Axis
axis_x <- seq(min(opioid_outliers$Median.Income), max(opioid_outliers$Median.Income), by = 1000)
axis_y <- seq(min(opioid_outliers$Home.Price), max(opioid_outliers$Home.Price), by = 10000)
#Sample points
lm_surface <- expand.grid(Median.Income = axis_x,Home.Price = axis_y, KEEP.OUT.ATTRS = F)
#View(lm_surface)
lm_surface$Death.Rate <- predict.lm(rline_outliers, newdata = lm_surface)
lm_surface <- acast(lm_surface, Home.Price ~ Median.Income, value.var = "Death.Rate") #y ~ x
#scatterplot of data
#hcolors=c("red","blue","green")[my_df$Species]
dot_plot <- plot_ly(opioid_outliers, 
                     x = ~Median.Income, 
                     y = ~Home.Price, 
                     z = ~Death.Rate,
                     type = "scatter3d")
#adding surface to plot
outlier_plot <- add_trace(p = dot_plot,
                       z = lm_surface,
                       x = axis_x,
                       y = axis_y,
                       type = "surface")

outlier_plot
```
```{r eval=FALSE}
str(opioid)
```
```{r}
opioid_outliers_transform<-opioid[-c(22,25),]
rline_outliers_transform<-lm(formula = sqrt(opioid_outliers_transform$Death.Rate) ~ opioid_outliers_transform$Median.Income+opioid_outliers_transform$Home.Price)
```



```{reval=FALSE}

library(plotly)
library(reshape2)
a<-seq(min(opioid_outliers_transform$Median.Income),max(opioid_outliers_transform$Median.Income), by=1000)
b<-seq(min(opioid_outliers_transform$Home.Price), max(opioid_outliers_transform$Home.Price), by=10000)

data<-expand.grid(Median.Income=a, Home.Price=b, KEEP.OUT.ATTRS = F)

lm$Death.Rate<-predict(rline_outliers_transform, newdata=data)
lm<-acast(lm, Home.Price~Median.Income, value.var = "Death.Rate")
```
```{r}
library(plotly)
library(reshape2)
opioid_outliers_transform_v2<-opioid[-c(22,25),]
rline_outliers_transform_v2_graph<-lm(formula = sqrt(Death.Rate) ~ Median.Income+Home.Price, data=opioid_outliers_transform_v2)
#Setup Axis
axis_x2 <- seq(min(opioid_outliers_transform_v2$Median.Income), max(opioid_outliers_transform_v2$Median.Income), by = 1000)
axis_y2 <- seq(min(opioid_outliers_transform_v2$Home.Price), max(opioid_outliers_transform_v2$Home.Price), by = 10000)
#Sample points
lm_surface2 <- expand.grid(Median.Income = axis_x2,Home.Price = axis_y2,KEEP.OUT.ATTRS = F)
lm_surface2$Death.Rate <- predict.lm(rline_outliers_transform_v2_graph, newdata = lm_surface2)
lm_surface2 <- acast(lm_surface2, Home.Price ~ Median.Income, value.var = "Death.Rate") #y ~ x
#scatterplot of data
#hcolors=c("red","blue","green")[my_df$Species]
dot_plot2 <- plot_ly(opioid_outliers_transform_v2, 
                     x = ~Median.Income, 
                     y = ~Home.Price, 
                     z = ~Death.Rate,
                     type = "scatter3d")
#adding surface to plot
outlier_plot2 <- add_trace(p = dot_plot2,
                       z = lm_surface2,
                       x = axis_x2,
                       y = axis_y2,
                       type = "surface")

outlier_plot2
```
